<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>R packages with Lua code • luajr</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="R packages with Lua code">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">luajr</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.9.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/luajr.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/objects.html">R objects in Lua code</a></li>
    <li><a class="dropdown-item" href="../articles/packages.html">R packages with Lua code</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/nicholasdavies/luajr/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>R packages with Lua code</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/nicholasdavies/luajr/blob/HEAD/vignettes/packages.Rmd" class="external-link"><code>vignettes/packages.Rmd</code></a></small>
      <div class="d-none name"><code>packages.Rmd</code></div>
    </div>

    
    
<p>The <a href="luajr.html">Introduction to <code>luajr</code></a>
vignette shows you how to get started with calling Lua code from R. This
vignette shows you how to integrate Lua code into your R package, either
for internal use within the package or for direct use by your package’s
users.</p>
<div class="section level2">
<h2 id="the-simple-way-for-an-individual-function">The simple way for an individual function<a class="anchor" aria-label="anchor" href="#the-simple-way-for-an-individual-function"></a>
</h2>
<p>Generally when you want to include Lua code in your package, it means
that you want to include one or more functions written in Lua either
internally in your package or as an outward-facing function for your
users.</p>
<p>In Lua, the standard way to write a “module” – Lua’s equivalent of
R’s packages – is to put together a Lua script that returns a table,
where the table contains all the functions (or variables) that the
module should export. The script can also contain local functions or
variables that are accessible only within the module itself, and the
module is then loaded with Lua’s <code>require</code> function. For
example, you may have a script <code>mymodule.lua</code> containing this
Lua code:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode lua"><code class="sourceCode lua"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="kw">local</span> <span class="va">mymodule</span> <span class="op">=</span> <span class="op">{}</span></span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a><span class="kw">local</span> <span class="va">fave_name</span> <span class="op">=</span> <span class="st">"Nick"</span></span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a><span class="kw">function</span> <span class="va">mymodule</span><span class="op">.</span>greet<span class="op">(</span><span class="va">name</span><span class="op">)</span></span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a>    <span class="fu">print</span><span class="op">(</span><span class="st">"Hello, "</span> <span class="op">..</span> <span class="va">name</span> <span class="op">..</span> <span class="st">"!"</span><span class="op">)</span></span>
<span id="cb1-7"><a href="#cb1-7" tabindex="-1"></a>    <span class="cf">if</span> <span class="va">name</span> <span class="op">==</span> <span class="va">fave_name</span> <span class="cf">then</span></span>
<span id="cb1-8"><a href="#cb1-8" tabindex="-1"></a>        <span class="fu">print</span><span class="op">(</span><span class="st">"Incidentally, that's a great name. Nice one."</span><span class="op">)</span></span>
<span id="cb1-9"><a href="#cb1-9" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb1-10"><a href="#cb1-10" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb1-11"><a href="#cb1-11" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" tabindex="-1"></a><span class="cf">return</span> <span class="va">mymodule</span></span></code></pre></div>
<p>This returns a Lua table containing the function <code>greet</code>,
which in turn makes use of the “private” (local) variable
<code>fave_name</code>. In Lua, to use this module, you would write
something like:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode lua"><code class="sourceCode lua"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="kw">local</span> <span class="va">mymod</span> <span class="op">=</span> <span class="fu">require</span> <span class="st">"mymodule"</span></span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a><span class="va">mymod</span><span class="op">.</span>greet<span class="op">(</span><span class="st">"Janet"</span><span class="op">)</span></span></code></pre></div>
<p>Here, Lua’s <code>require</code> looks for a script called
<code>mymodule.lua</code> in a few places, including the current working
directory. For more information on Lua modules, see the <a href="http://lua-users.org/wiki/ModulesTutorial" class="external-link">Lua wiki</a> and the <a href="https://www.lua.org/manual/5.4/manual.html#pdf-require" class="external-link">Lua
manual</a>.</p>
<p>You can use a similar technique to load functions from a Lua module
into R as follows. The recommendation is that you put
<code>mymodule.lua</code> in your package directory under the
subdirectory <code>inst/Lua</code>; then when your package is installed,
you can get the path to this module file using
<code>system.file("Lua", "mymodule.lua", package = "myPackage")</code>,
where <code>"myPackage"</code> is the name of your R package. Then
create a new R script in the <code>R</code> subdirectory of your
package, called e.g. <code>lua_exports.R</code>, with the following
code:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Package Lua state</span></span>
<span><span class="va">pkgL</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span></span>
<span><span class="co">#' Greet the user</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' This function prints a greeting to someone.</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @usage greet(name)</span></span>
<span><span class="co">#' @param name The name of the person to be greeted.</span></span>
<span><span class="co">#' @return Nothing.</span></span>
<span><span class="co">#' @export</span></span>
<span><span class="va">greet</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span></span>
<span><span class="va">.onLoad</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">libname</span>, <span class="va">pkgname</span><span class="op">)</span></span>
<span><span class="op">{</span></span>
<span>    <span class="co"># Obtain the package namespace</span></span>
<span>    <span class="va">ns</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ns-internal.html" class="external-link">asNamespace</a></span><span class="op">(</span><span class="va">pkgname</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Create a Lua state for this package</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/assign.html" class="external-link">assign</a></span><span class="op">(</span><span class="st">"pkgL"</span>, <span class="fu">luajr</span><span class="fu">::</span><span class="fu"><a href="../reference/lua_open.html">lua_open</a></span><span class="op">(</span><span class="op">)</span>, envir <span class="op">=</span> <span class="va">ns</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Load the module in our package state</span></span>
<span>    <span class="va">mymod</span> <span class="op">&lt;-</span> <span class="fu">luajr</span><span class="fu">::</span><span class="fu"><a href="../reference/lua.html">lua</a></span><span class="op">(</span>filename <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"Lua"</span>, <span class="st">"mymodule.lua"</span>,</span>
<span>        package <span class="op">=</span> <span class="st">"luajrtest"</span><span class="op">)</span>, L <span class="op">=</span> <span class="va">pkgL</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Add functions to the package namespace</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/assign.html" class="external-link">assign</a></span><span class="op">(</span><span class="st">"greet"</span>, <span class="fu">luajr</span><span class="fu">::</span><span class="fu"><a href="../reference/lua_func.html">lua_func</a></span><span class="op">(</span><span class="va">mymod</span><span class="op">$</span><span class="va">greet</span>, <span class="st">"1"</span>, L <span class="op">=</span> <span class="va">pkgL</span><span class="op">)</span>, envir <span class="op">=</span> <span class="va">ns</span><span class="op">)</span></span>
<span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/invisible.html" class="external-link">invisible</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>There are three sections here. First, we create the variable
<code>pkgL</code> which will hold the Lua state used by the functions in
our package.</p>
<p>Second, we create the variable <code>greet</code> which is a
placeholder for the function <code>greet</code> within the Lua module.
We document this object as though it was a function, with parameters
defined. Note that we provide an explicit <code>@usage</code> tag
because roxygen can’t guess the parameters just by inspecting the
object’s declaration (which is <code>NULL</code> at this point). We also
mark it for <code>@export</code>.</p>
<p>Finally, we write the <code>.onLoad</code> function which is
automatically called whenever our package is loaded. (See the R
documentation <code><a href="https://rdrr.io/r/base/ns-hooks.html" class="external-link">?.onLoad</a></code> for details.) Within this function,
we create the Lua state in <code>pkgL</code>, load the module as a list
<code>mymod</code>, and then assign to the variable <code>greet</code>
using <code><a href="../reference/lua_func.html">lua_func()</a></code>.</p>
<p>Note that <code>mymod</code> is a list containing the member
<code>greet</code>, which is an external pointer to the Lua function.
This pointer cannot be used directly as a function, but has to be passed
through <code><a href="../reference/lua_func.html">lua_func()</a></code> so that we can specify the
<code>argcode</code> argument which determines the function’s parameter
passing behaviour.</p>
<p>For each new function you want to import from your Lua module, you
will have to add a new “placeholder” (like <code>greet</code> above),
(optionally) document the placeholder with details of how to call the
function, mark the function for <code>@export</code> (if you want it to
be available to end users of the package), and use <code>assign</code>
to actually load the corresponding function into place.</p>
</div>
  </main>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Maintained by Nicholas Davies.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
